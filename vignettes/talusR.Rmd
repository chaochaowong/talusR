---
title: "Introduction to talusR"
author:
  - name: "Chao-Jen Wong"
    affiliation: "Seattle Children's Research Institute"
    email: chao-jen.wong@seattlechildrens.org
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc_float: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Introduction to talusR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  eval = TRUE, 
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE,
  fig.align = 'center',
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 4
)
```

# Getting started

For now, this package only takes Talus data that are pre-processed by DIANN—i.e. that executed the normalization process and summarized the intensity signal in protein-level file (`*.tsv` or `*.csv`). The input metadata table (`*.csv`) must include a column (`which_run`) whose entries exactly match the sample (run) names in that abundance file.

This package also assumes that Talus processes only one sample in a single run (one mass-spectrometer acquisition) and with DIA-NN executed the normalization process across all the runs. 

Install `talusR`:
```{r install-talusR, eval=FALSE}
devtools::install_github('chaochaowong/talusR',
                         ref          = "dev",
                         dependencies = TRUE,
                         build_vignettes = TRUE
)

# or to install the Bioconductor dependencies
BiocManager::install(
  "chaochaowong/talusR@dev",
  dependencies = TRUE
  build_vignettes = TRUE
)
```

```{r load-library}
library(talusR)
```

# Import Talus data
Import test files by `read_talus()`.

## `split_by_fraction = FALSE`
When `split_by_fraction = FALSE`, `read_talus()` returns a single `TalusDataSet`.  This mode is ideal when:

- Your data have no fraction annotations       
- You want to run PCA-based QC to verify that protein-level signals from each fraction cluster as expected        

```{r assemble-files}
# get paths
protein_file <- system.file('extdata', 'test_data.tsv', 
                            package = 'talusR')
meta_file    <- system.file('extdata', 'test_meta.csv',
                            package = 'talusR')
```
```{r import-test-data}
# without split by fraction -> return TalusDataSet
tds  <- talusR::read_talus(file = protein_file,
                           meta_file = meta_file,
                           which_proteinid = "Protein.Ids",
                           which_run = "Run",
                           remove_few_measurements = TRUE,
                           split_by_fraction = FALSE)
tds
```

### QC: PCA
Use PCA to verify that protein-level signals from each fraction cluster as expected.
```{r pca-tds, fig.cap='PCA on TalusDataSet.'}
talusR::plot_pca(tds, color_by='Frx')
```

## `split_by_fraction = TRUE`
When `split_by_fraction = TRUE`, `read_talus()` returns a `TalusDataSetList` — a `SimpleList` of `TalusDataSet` objects, one per fraction, each holding its protein-level signals.

```{r split-by-fraction}
tdsl <- read_talus(file = protein_file,
                   meta_file = meta_file,
                   which_proteinid = "Protein.Ids",
                   which_fraction = "Frx",
                   which_sequence = NA,
                   which_run = "Run",
                   remove_few_measurements = TRUE,
                   split_by_fraction = TRUE,
                   log_transform = 'log2',
                   intensity_group = "protein",
                   metric = "DIA-NN")
# not sure why tdsl is a list!!! need to debug
tdsl
```

### QC: PCA
```{r pca-for-TalusDataSetList, fig.cap='PCA performed separately on each fraction in the TalusDataSetList.'}
plot_pca(tdsl, color_by='Tx')
```

# Differential analysis

## `limma`
Use `talus_limma()`, a wrapping function of `limma`, to perform differential analysis. 

```{r limma}
res_limma <- talus_limma(tdsl, design = ~ 0 + Tx)
```

Summarize the limma results and filter to retain the significant proteins. 
```{r summarize-limma}
limma_filt <- summary_talus(res_limma[['chrom']], 
                            alpha = 0.05, 
                            lfc_threshold = 0.5)
limma_filt
```

Visualize the statistiics by `plot_volcano()`:
```{r volcano-limma}
plot_volcano(res_limma[['chrom']], 
             alpha = 0.05,
             lfc_threshold = 0.5, 
             use_adjP = TRUE, 
             label_top_n=10)
```

## Row-t test

Perform row-t tests on by `talus_row_t_welch()`. It returns a list of `data.frame` if the input is is a `TalusDataSetList` object.  
```{r row-t-welch, eval=FALSE}
res_t <- talus_row_t_welch(tdsl, design = ~ 0 + Tx)
names(res_t)
```

Display summary of the t tests and filter the results by `summary_talus()`. The input must be a `data.frame`:
```{r show-row-t-summary}
ttest_filt <- summary_talus(res_t[['chrom']], 
                            alpha = 0.05, 
                            lfc_threshold = 0.5)
```

Visualize the statistics by `plot_volcano()`. 
```{r viz-t-welch-by-volcano}
plot_volcano(res_t[['chrom']], 
             alpha = 0.05,
             lfc_threshold = 0.5, 
             use_adjP = TRUE, 
             label_top_n=10)
```





