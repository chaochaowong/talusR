---
title: "Introduction to talusR"
author:
  - name: "Chao-Jen Wong"
    affiliation: "Seattle Children's Research Institute"
    email: chao-jen.wong@seattlechildrens.org
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc_float: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Introduction to talusR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  eval = TRUE, 
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE,
  fig.align = 'center',
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 4
)
```

# Getting started

For now, this package only takes Talus data that are pre-processed by DIANN—i.e. that accounts for the normalization process and summary of the protein-level intensity signals (`*.tsv` or `*.csv`). 

__NOTE:__ The input metadata table (`*.csv`) must include a column (`run`) whose entries exactly match the sample names in that signal file.

This package also assumes that Talus processes only one sample in a single run (one mass-spectrometer acquisition) and with DIA-NN executed the normalization process across all the runs. 

If `talusR` is not yet install:
```{r install-talusR, eval=FALSE}
devtools::install_github('chaochaowong/talusR',
                         ref          = "dev",
                         build_vignettes = TRUE)

# or install along with the Bioconductor dependencies with appropriate version
BiocManager::install("chaochaowong/talusR@dev",
                     dependencies = TRUE
                     build_vignettes = TRUE
)
```

Load the library:
```{r load-library}
library(talusR)
```

# Import Talus data
Import test files by `read_talus()` and use `plot_pca` for quality control.

## `split_by_fraction = FALSE`
When `split_by_fraction = FALSE`, `read_talus()` returns a single `TalusDataSet` instance.  This mode is ideal when:

- Your data have no fraction annotations       
- You want to run PCA-based QC to verify that protein-level signals from each fraction cluster as expected        

```{r assemble-files}
# get paths
protein_file <- system.file('extdata', 'test_data.tsv', 
                            package = 'talusR')
meta_file    <- system.file('extdata', 'test_meta.csv',
                            package = 'talusR')
```
```{r import-test-data}
# without split by fraction -> return TalusDataSet
tds  <- talusR::read_talus(file = protein_file,
                           meta_file = meta_file,
                           which_proteinid = "Protein.Ids",
                           which_run = "Run",
                           remove_few_measurements = TRUE,
                           split_by_fraction = FALSE)
tds
```

### QC: PCA
Use PCA to verify that protein-level signals from each fraction cluster as expected.
```{r pca-tds, fig.cap='PCA on TalusDataSet.'}
talusR::plot_pca(tds, color_by='Frx')
```

## `split_by_fraction = TRUE`
When `split_by_fraction = TRUE`, `read_talus()` returns a `TalusDataSetList` instance—a `SimpleList` of `TalusDataSet` instances, one per fraction, each holding its protein-level signals.

```{r split-by-fraction}
tdsl <- read_talus(file = protein_file,
                   meta_file = meta_file,
                   which_proteinid = "Protein.Ids",
                   which_fraction = "Frx",
                   which_sequence = NA,
                   which_run = "Run",
                   remove_few_measurements = TRUE,
                   split_by_fraction = TRUE,
                   log_transform = 'log2',
                   intensity_group = "protein",
                   metric = "DIA-NN")

tdsl
```

### QC: PCA
```{r pca-for-TalusDataSetList, fig.cap='PCA performed separately on each fraction in the TalusDataSetList instance.'}
plot_pca(tdsl, color_by='Tx')
```

# Differential analysis
Statistics methods:
- `talus_limma`: a wrapping function of `limma`.   
- `talus_rwo_t_welch`: a wrapping function of `matrixTests::row_t_welch()`.    

Other tools:
- `summary_talus`: summarize the differential analysis and identify the significant proteins. 
- `plot_volcano`: plot volcano plot.     
- `plot_per_pertein`: plot signals for a protein across fractions.  


## `limma`
Use `talus_limma()`, a wrapping function of `limma`, to perform differential analysis. 

Set the factor levels for `Tx` with _DMSO_ as the reference (positive control) and _etopo_ and _doxo_ as treatment levels to be compared against _DMSO_.

Define factor levels for the contrast variable, `Tx`. In this demo, `DMSO` is the positive control, `etopo` and `doxo` are treatments to be contrasted again `DMSO`. 
```{r define-tx-levels}
tx_levels <- c('DMSO', 'etopo', 'doxo')
tdsl <- endoapply(tdsl, function(x) {
  colData(x)$Tx <- factor(colData(x)$Tx, levels = tx_levels)
  x
})
```
```{r limma}
res_limma <- talus_limma(tdsl, design = ~ 0 + Tx)
```

Summarize the limma results and filter to retain the significant proteins. 
```{r summarize-limma}
limma_filt <- summary_talus(res_limma[['chrom']], 
                            alpha = 0.05, 
                            lfc_threshold = 0.5)
limma_filt
```

Visualize the statistiics by `plot_volcano()`:
```{r volcano-limma}
plot_volcano(res_limma[['chrom']], 
             alpha = 0.05,
             lfc_threshold = 0.5, 
             use_adjP = TRUE, 
             label_top_n=10)
```

## Row-t test

Perform row-t tests on by `talus_row_t_welch()`. It returns a list of `data.frame` if the input is is a `TalusDataSetList` object.  
```{r row-t-welch}
res_t <- talus_row_t_welch(tdsl, design = ~ 0 + Tx)
names(res_t)
```

Display summary of the t tests and filter the results by `summary_talus()`. The input must be a `data.frame`:
```{r show-row-t-summary}
# show contrast level
cat('\nContrast levels:\n')
names(res_t[['chrom']])

# summarize the result per fraction
ttest_filt <- summary_talus(res_t[['chrom']], 
                            alpha = 0.05, 
                            lfc_threshold = 0.5)
```

Visualize the statistics by `plot_volcano()`. 
```{r viz-t-welch-by-volcano}
# try to re-arrange the contrast_levels
plot_volcano(res_t[['chrom']], 
             alpha = 0.05,
             lfc_threshold = 0.5, 
             use_adjP = TRUE,
             contrast_levels = names(res_t[['chrom']])[c(2, 1)],
             label_top_n=10)
```

## Per-protein plot
```{r plot-per-protein}
protein_id <- as.data.frame(rowData(tdsl[[1]])) %>% 
  dplyr::filter(Genes == 'TOP2A') %>% pull(Protein.Group)

plot_per_protein(tdsl, 
                 protein_id = 'P11388;P11388-2;P11388-3;P11388-4',
                 group_by = 'Tx') +
  labs(title = 'TOP2A')
```





